import flet as ft
import os
import json
import keyboard
import uuid
import hashlib
import socket
import threading
import winsound as ws
import sys
import random
import string

if getattr(sys, 'frozen', False):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –±–∏–Ω–∞—Ä–Ω–∏–∫
    base_path = sys._MEIPASS  # –ü—É—Ç—å –∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–ø–∫–µ Nuitka
else:
    base_path = os.path.dirname(__file__)  # –û–±—ã—á–Ω—ã–π –ø—É—Ç—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
assets_path = os.path.join(base_path, "assets")


######################################################################################################################################################
#—Ü—ã—Ç–∞—Ç—ã
#–∑–∞–ª–∏–ø–∞—Ç–µ–ª—å–Ω—ã–π –≥—É–¥–æ–∫
#—Å—Å—ã–ª–∫–∞ –Ω–∞ –¥—Å
#  
#
#
#
#
#
#
######################################################################################################################################################


######################################################################################################################################################


        
def main(page: ft.Page):
    def on_close(e):
        if e.data == "close":
            process_name = "flet.exe"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω–æ–µ –∏–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞
            os.system(f"taskkill /F /IM {process_name}")
            os._exit(0)
    
    
    page.theme_mode = ft.ThemeMode.DARK
    page.bgcolor = ft.Colors.BLACK

    # –ó–∞–¥–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞
    page.window.width = 600
    page.window.height = 700
    page.window.maximizable = False
    page.window.resizable = False
    page.title = "–ö—Ä–∞–∫–∞—É—Ç 2MRDR —Ö—É–π –∑–Ω–∞–µ—Ç —á—Ç–æ "
    page.window.center()
    page.vertical_alignment = ft.MainAxisAlignment.CENTER  # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
    page.horizontal_alignment = ft.CrossAxisAlignment.CENTER  # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
    page.window.icon = f"{assets_path}/icon.ico"
    page.window.prevent_close = True
    page.window.on_event = on_close
    ##################################################################################################################################################
    global client
    activation_toggle = False
    
    
    ##################################################################################################################################################

    def pagep(t):
        page.overlay.append(ft.SnackBar(content=ft.Text(t),open = True))
        print(t)
        page.update()
        


    ##################################################################################################################################################
    #—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏ 
    #PROFILES_DIR = os.path.join(os.path.dirname(__file__), "profiles")


    appdata_path = os.getenv('APPDATA')  # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ %APPDATA%
    PROFILES_DIR = os.path.join(appdata_path, '2MRDR', 'profiles')  # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏
    os.makedirs(os.path.dirname(PROFILES_DIR), exist_ok=True)  # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
    SETTINGS_FILE = os.path.join(appdata_path, '2MRDR', 'settings.json')


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    def save_settings(settings):
        with open(SETTINGS_FILE, "w") as f:
            json.dump(settings, f)
    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    def load_settings():
        global load_settingsapp, save_app_settings
        if os.path.exists(SETTINGS_FILE):
            with open(SETTINGS_FILE, "r") as f:
                return json.load(f)
        else:
            # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å —à–∞–±–ª–æ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            default_settings = {
                "last_profile": None,
                "ip": "2MRDR",
                "port": 25100,
                "sound_enable": False,
                "hotkey": "G",
                "hotkeyscan": 34,
                "hotkeycruis": "H",
                "hotkeycruisscan": 35,
                "hotkeytogslider": False,
                "private_key": ''.join(random.choices(string.ascii_letters + string.digits, k=8)),
            }
            save_settings(default_settings)
            return default_settings
            
    load_settings()
    
    

    def save_app_settings():
        settings = {
                "last_profile": profile_dropdown.value,
                "ip": ip_input.value,
                "port": port_input.value,
                "sound_enable": sound_enable.value,
                "hotkey": hotkey.text,
                "hotkeyscan": toggle_key,
                "hotkeycruis": hotkeycruis.text,
                "hotkeycruisscan": toggle_keycruis,
                "hotkeytogslider": hotkeytogslider.value,
                "private_key": private_key_input.value,
            }
        save_settings(settings)
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    app_settings = load_settings()
    
    def load_settingsapp():
        global toggle_key, toggle_keycruis
        nonlocal app_settings
        try:
            ip_input.value = app_settings['ip']
            port_input.value = app_settings['port']
            sound_enable.value = app_settings['sound_enable']
            hotkey.text = app_settings['hotkey']
            toggle_key = app_settings['hotkeyscan']
            hotkeycruis.text = app_settings['hotkeycruis']
            toggle_keycruis = app_settings['hotkeycruisscan']
            hotkeytogslider.value = app_settings['hotkeytogslider']
            private_key_input.value = app_settings['private_key']
        except:
            pagep("Error loading settings")
    
    new_profile_name = ft.TextField(label="–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è",width=200)

    dlg_new_profile = ft.AlertDialog(
        modal=True,
        title=ft.Text("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è"),
        content=new_profile_name,
        actions=[
            ft.TextButton("–°–æ–∑–¥–∞—Ç—å", on_click=lambda e: (create_profile(new_profile_name.value, page),setattr(new_profile_name, 'value', ""), page.close(dlg_new_profile))),
            ft.TextButton("–û—Ç–º–µ–Ω–∞", on_click=lambda e: page.close(dlg_new_profile)),
        ],
        actions_alignment=ft.MainAxisAlignment.END,
        on_dismiss=None,
        )


    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π
    def load_profiles():
        if not os.path.exists(PROFILES_DIR):
            os.makedirs(PROFILES_DIR)
        profiles = {}
        for filename in os.listdir(PROFILES_DIR):
            if filename.endswith(".json"):
                with open(os.path.join(PROFILES_DIR, filename), "r") as f:
                    profiles[filename[:-5]] = json.load(f)
        return profiles

    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    def save_profile(profile_name, settings):
        with open(os.path.join(PROFILES_DIR, f"{profile_name}.json"), "w") as f:
            json.dump(settings, f)

    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    def delete_profile(profile_name):
        os.remove(os.path.join(PROFILES_DIR, f"{profile_name}.json"))


    # –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π
    profiles = load_profiles()

    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ—Ñ–∏–ª—è
    def apply_profile(profile_name, page):
        global settings
        profiles = load_profiles()
        if profile_name in profiles:
            try:
                settings = profiles[profile_name]
                keys_input.value = settings['keys']
                replace_key_input.value = settings['replace_key']
            except:
                pagep("Error applying profile")
            
            profiles = load_profiles()
            profile_dropdown.options=[ft.dropdown.Option(key=name) for name in profiles.keys()]

            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
            save_app_settings()

            page.update()

    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
    def save_current_profile(page):
        current_profile = profile_dropdown.value
        if current_profile:
            settings = {
                "keys": keys_input.value,
                "replace_key": replace_key_input.value,
            }
            save_profile(current_profile, settings)
            profiles[current_profile] = settings

    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
    def create_profile(profile_name, page):
        global settings
        profiles = load_profiles()
        if profile_name and profile_name not in profiles:
            settings = {
                "keys": "w,a,s,d,space",
                "replace_key": "a=b;d=c,e",
            }
            save_profile(profile_name, settings)
            profiles[profile_name] = settings
            profile_dropdown.options.append(ft.dropdown.Option(key=profile_name))
            profile_dropdown.value = profile_name
            apply_profile(profile_name, page)
            page.update()

    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –∏ –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ
    def delete_current_profile(page):
        profiles = load_profiles()
        current_profile = profile_dropdown.value
        if current_profile:
            delete_profile(current_profile)
            del profiles[current_profile]
            profile_dropdown.options = [ft.dropdown.Option(key=name) for name in profiles.keys()]
            # –ï—Å–ª–∏ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏, –≤—ã–±–∏—Ä–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π
            if profiles:
                next_profile = list(profiles.keys())[0]
                profile_dropdown.value = next_profile
                apply_profile(next_profile, page)
            else:
                profile_dropdown.value = None

            page.update()



    ##################################################################################################################################################
    #settings menu
    #–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ##################################################################################################################################################

    hotkey = ft.OutlinedButton(
        text="None",
        autofocus=False,
        width=70,
        height=50,
        on_click=lambda e: set_hotkey(e),
        style=ft.ButtonStyle(color="white",side={ft.ControlState.DEFAULT: ft.BorderSide(1, ft.Colors.BLACK)},shape=ft.RoundedRectangleBorder(radius=5),)
    )
    hotkeyw = ft.AlertDialog(title=ft.Text("–ù–∞–∂–º–∏—Ç–µ –∫–ª–∞–≤–∏—à—É –¥–ª—è —Ö–æ—Ç–∫–µ—è"),modal=True)
    def set_hotkey(e):
        page.open(hotkeyw)
        page.update()
        keyboard.on_press(on_key_event)  # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏—à

    def on_key_event(e):
        global toggle_key
        hotkey.text = e.name.upper()
        toggle_key = e.scan_code
        
        save_current_profile(page)
        page.open(dlg_settings)
        page.update()
        keyboard.unhook_all()
        keyboard.hook(on_press)
        update_keys()
    
    
    ##################################################################################################################################################
    hotkeycruis = ft.OutlinedButton(
        text="None",
        autofocus=False,
        width=70,
        height=50,
        on_click=lambda e: set_hotkeycruis(e),
        style=ft.ButtonStyle(color="white",side={ft.ControlState.DEFAULT: ft.BorderSide(1, ft.Colors.BLACK)},shape=ft.RoundedRectangleBorder(radius=5),)
    )
    
    hotkeytogslider = ft.Switch(
        label="–í–∫–ª/–í—ã–∫–ª",
        value=False,
        scale=1.2,
        thumb_icon={ft.ControlState.DEFAULT: ft.Icons.KEYBOARD},
        label_position=ft.LabelPosition.LEFT,
    )

    def set_hotkeycruis(e):
        page.open(hotkeyw)
        
        page.update()
        keyboard.on_press(on_key_eventcruis)  # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏—à
        
    def on_key_eventcruis(e):
        global toggle_keycruis
        hotkeycruis.text = e.name.upper()
        toggle_keycruis = e.scan_code
        
        save_current_profile(page)
        page.open(dlg_settings)
        page.update()
        keyboard.unhook_all()
        keyboard.hook(on_press)
        update_keys()
    ##################################################################################################################################################
    
    ip_input = ft.TextField(
        label="IP-–∞–¥—Ä–µ—Å",
        label_style=ft.TextStyle(color=ft.Colors.WHITE),
        value=None,
        width=400,
        text_align=ft.TextAlign.CENTER,
        color=ft.Colors.WHITE,
        on_submit = lambda e: client_connect(),
        #on_blur = lambda e: pagep("on_blur"),
        #on_focus = lambda e: pagep("on_focus"),
    )
    
    port_input = ft.TextField(
        label="–ü–æ—Ä—Ç",
        label_style=ft.TextStyle(color=ft.Colors.WHITE),
        value=None,
        width=400,
        color=ft.Colors.WHITE,
        text_align=ft.TextAlign.CENTER,
        on_submit = lambda e: client_connect(),
        )

    def sl_sound_toggle():
        if sound_enable.value:
            sound_enable.thumb_icon = {ft.ControlState.DEFAULT: ft.Icons.VOLUME_UP_OUTLINED}
        else:
            sound_enable.thumb_icon = {ft.ControlState.DEFAULT: ft.Icons.VOLUME_OFF}
        page.update()
    
    sound_enable = ft.Switch(
        label="–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫",
        value=False,
        scale=1.2,
        thumb_icon={ft.ControlState.DEFAULT: ft.Icons.FILE_UPLOAD_OFF},
        on_change = lambda e: (sl_sound_toggle()),
        label_position=ft.LabelPosition.LEFT,
    )
    
    dskey = ft.TextButton(
        "üîä Discord",
        scale=1.2,
        on_click=lambda e: os.system("start https://discord.gg/D5nav84yCX")
    )
    
    rowhotkey_settings = ft.Row([ft.Text("–•–æ—Ç–∫–µ–π –í–∫–ª/–í—ã–∫–ª"), hotkey],alignment=ft.alignment.center)
    containerhotkey_settings = ft.Container(
        content=ft.Column([rowhotkey_settings,sound_enable],alignment=ft.alignment.center,horizontal_alignment=ft.CrossAxisAlignment.CENTER,expand=False),
        alignment=ft.alignment.center,
        expand=False,
        border=ft.border.all(1, ft.Colors.BLACK),
        border_radius=10,
        padding=10,
    )
    
    containerip_settings = ft.Container(
        content=ft.Column([ip_input,port_input],alignment=ft.alignment.center,horizontal_alignment=ft.CrossAxisAlignment.CENTER,expand=False),
        alignment=ft.alignment.center,
        expand=False,
        border=ft.border.all(1, ft.Colors.BLACK),
        border_radius=10,
        padding=10,
    )
    
    rowcruis_settings = ft.Row([ft.Text("–ö—Ä—É–∏–∑-–∫–æ–Ω—Ç—Ä–æ–ª—å"), hotkeycruis],alignment=ft.alignment.center)
    containercruis_settings = ft.Container(
        content=ft.Column([rowcruis_settings,hotkeytogslider],alignment=ft.alignment.center,horizontal_alignment=ft.CrossAxisAlignment.CENTER,expand=False),
        alignment=ft.alignment.center,
        expand=False,
        border=ft.border.all(1, ft.Colors.BLACK),
        border_radius=10,
        padding=10,
    )   
    
    
    dlg_settings = ft.AlertDialog(
        modal=True,
        title=ft.Container(content=ft.Text("–ù–∞—Å—Ç—Ä–æ–π–∫–∏"),alignment=ft.alignment.center,expand=True,),
        title_padding=10,
        content=ft.Column([containerhotkey_settings,containercruis_settings,containerip_settings],alignment=ft.MainAxisAlignment.START,horizontal_alignment=ft.CrossAxisAlignment.CENTER,expand=True,),
        content_padding=10,
        actions=[ft.TextButton("–ü—Ä–∏–º–µ–Ω–∏—Ç—å", on_click=lambda e: (save_app_settings(), page.close(dlg_settings), client_connect()),width=200,height=50)],
        actions_alignment=ft.MainAxisAlignment.CENTER,
    )
    
    whitelist_id = ft.TextField(label="–¢–≤–æ–π whitelist –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä",value=None,width=300,color=ft.Colors.WHITE,text_align=ft.TextAlign.CENTER,border_color=ft.Colors.WHITE,read_only=True)
    whitelistdlg = ft.AlertDialog(
        modal=True,
        title=ft.Container(content=ft.Text("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"),alignment=ft.alignment.center,expand=True,),
        content=ft.Column([ft.Text("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É, –≤–µ—Ä–æ—è—Ç–Ω–æ —Ç–µ–±—è –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫, –ø–æ–ø—Ä–æ—Å–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–±—è –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫, –Ω–∞—Å –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –Ω–∞ –Ω–∞—à–µ–º —Å–µ—Ä–≤–µ—Ä–µ –≤ Discord"),whitelist_id],width=300,height=300,alignment=ft.MainAxisAlignment.SPACE_EVENLY,horizontal_alignment=ft.CrossAxisAlignment.CENTER,expand=True,),
        actions=[dskey,ft.TextButton("–ó–∞–∫—Ä—ã—Ç—å",scale=1.2, on_click=lambda e: page.window.close())],
        actions_alignment=ft.MainAxisAlignment.CENTER,
    )
   
    ##################################################################################################################################################



    ##################################################################################################################################################
    

    profile_dropdown = ft.Dropdown(
        options=[ft.dropdown.Option(key=name) for name in profiles.keys()],
        on_change=lambda e: (apply_profile(e.control.value, page), update_keys()),
        width=220,
        border_color=ft.Colors.WHITE,
        label_style=ft.TextStyle(color=ft.Colors.WHITE,),
        color=ft.Colors.WHITE,
        bgcolor=ft.Colors.BLACK,
        )
    
    keys_input = ft.TextField(
        label="–ö–ª–∞–≤–∏—à–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞",
        tooltip="–ö–ª–∞–≤–∏—à–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é —Ñ–æ—Ä–º–∞—Ç \"w,a,s,d,space,shift,ctrl,alt,tab,esc,enter\")",
        label_style=ft.TextStyle(color=ft.Colors.WHITE),
        value=None,
        width=400,
        color=ft.Colors.WHITE,
        text_align=ft.TextAlign.CENTER,
        border_color=ft.Colors.WHITE,
        on_change = lambda e: (save_current_profile(page), update_keys()),
    )
    replace_key_input = ft.TextField(
        label="–ö–ª—é—á–∏ –ø–æ–¥–º–µ–Ω—ã (–ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ –ø–æ–¥—Å–∫–∞–∑–∫–µ)",
        label_style=ft.TextStyle(color=ft.Colors.WHITE),
        tooltip="–ö–ª—é—á–∏ –ø–æ–¥–º–µ–Ω—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é —Ñ–æ—Ä–º–∞—Ç \"a=b;c=d,e,r\")",
        value=None,
        width=400,
        color=ft.Colors.WHITE,
        text_align=ft.TextAlign.CENTER,
        border_color=ft.Colors.WHITE,
        on_change = lambda e: (save_current_profile(page), update_keys()),
        )

    private_key_input = ft.TextField(
        label="–ö–ª—é—á –ø—Ä–∏–≤–∞—Ç–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã",
        label_style=ft.TextStyle(color=ft.Colors.WHITE),
        value=None,
        width=290,
        color=ft.Colors.WHITE,
        text_align=ft.TextAlign.CENTER,
        border_color=ft.Colors.WHITE,
        on_submit = lambda e: apply_private_room(),
        password=True, 
        can_reveal_password=True
        )
   
    def apply_private_room():
        if len(private_key_input.value) >= 3 and len(private_key_input.value) <= 16:
            client.send(f"Join_room|{private_key_input.value}".encode('utf-8'))
            pagep(f"–£—Å–ø–µ—à–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É")
            save_app_settings()
        else:
            pagep("–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã, –¥–ª–∏–Ω–∞ –∫–ª—é—á–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 3 –¥–æ 16 —Å–∏–º–≤–æ–ª–æ–≤")   
    
    apply_button = ft.OutlinedButton(
        text="–ü—Ä–∏–º–µ–Ω–∏—Ç—å",
        width=100,
        height=50,
        style=ft.ButtonStyle(color=ft.Colors.WHITE,bgcolor=ft.Colors.BLACK,side={ft.ControlState.DEFAULT: ft.BorderSide(2)},shape=ft.RoundedRectangleBorder(radius=5),),
        #on_click=apply_settings,
        on_click=lambda e: apply_private_room(),
    )
    

    
    rowtop = ft.Row(
        controls=[
            profile_dropdown,
            ft.IconButton(icon=ft.Icons.PERSON_ADD,icon_size=18,width=32,tooltip="–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å",icon_color=ft.Colors.WHITE,on_click=lambda e: page.open(dlg_new_profile)),
            ft.IconButton(icon=ft.Icons.FOLDER,icon_size=18,width=32,tooltip="–û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏",icon_color=ft.Colors.WHITE,on_click=lambda e: os.system("start " + PROFILES_DIR)),
            ft.IconButton(icon=ft.Icons.DELETE,icon_size=18,width=32,tooltip="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å",icon_color=ft.Colors.WHITE,on_click=lambda e: delete_current_profile(page)),
            ft.Container(content=ft.IconButton(icon=ft.Icons.SETTINGS,icon_size=32,tooltip="–ù–∞—Å—Ç—Ä–æ–π–∫–∏",icon_color=ft.Colors.WHITE,on_click=lambda e: page.open(dlg_settings)),alignment=ft.alignment.top_right,expand=True,),
        ],
        alignment=ft.MainAxisAlignment.SPACE_BETWEEN,  # –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏
    )
    def sendersl_change(e):
        if sendersl.value:
            sendersl.thumb_icon = {ft.ControlState.DEFAULT: ft.Icons.FILE_UPLOAD}
        else:
            sendersl.thumb_icon = {ft.ControlState.DEFAULT: ft.Icons.FILE_UPLOAD_OFF}
        page.update()

    def receiversl_change(e):
        if receiversl.value:
            receiversl.thumb_icon = {ft.ControlState.DEFAULT: ft.Icons.FILE_DOWNLOAD}
        else:
            receiversl.thumb_icon = {ft.ControlState.DEFAULT: ft.Icons.FILE_DOWNLOAD_OFF}
        page.update()

    sendersl = ft.Switch(label="–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å",value=False,scale=1.2,thumb_icon={ft.ControlState.DEFAULT: ft.Icons.FILE_UPLOAD_OFF},on_change=sendersl_change)
    receiversl = ft.Switch(label="–ü—Ä–∏–Ω–∏–º–∞—Ç—å",value=False,scale=1.2,label_position=ft.LabelPosition.LEFT,thumb_icon={ft.ControlState.DEFAULT: ft.Icons.FILE_DOWNLOAD_OFF},on_change=receiversl_change)
    togglerow = ft.Row(
        controls=[
            sendersl,
            receiversl,
        ],
        alignment=ft.MainAxisAlignment.SPACE_EVENLY,
    )
    citate = ft.Text(
        value="–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É",
        width=450,
        color=ft.Colors.WHITE,
        text_align=ft.TextAlign.CENTER,
    )

    page.add(
        rowtop,
        ft.Column(controls=[togglerow,keys_input,replace_key_input,ft.Row(controls=[private_key_input,apply_button],alignment=ft.MainAxisAlignment.CENTER),],
            alignment=ft.MainAxisAlignment.CENTER,
            horizontal_alignment=ft.CrossAxisAlignment.CENTER,
            spacing=10,  # –û—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
            expand=True,  # –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
        ),
        citate,
        )
    
    load_settingsapp()
    last_profile = app_settings.get("last_profile", None)
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    if profiles:
        first_profile = last_profile if last_profile in profiles else list(profiles.keys())[0]
        profile_dropdown.value = first_profile
        apply_profile(first_profile, page)
    else:
        create_profile("2MRDR", page)

    page.update()

    ##################################################################################################################################################
    #–∫–ª–∏–µ–Ω—Ç
    ##################################################################################################################################################
    key_to_scan_code = {'esc': 1 ,'1': 2 ,'2': 3 ,'3': 4 ,'4': 5 ,'5': 6 ,'6': 7 ,'7': 8 ,'8': 9 ,'9': 10 ,'0': 11 ,'-': 12 ,'=': 13 ,'backspace': 14 ,
    ']': 27 ,'[': 26 ,'p': 25 ,'o': 24 ,'i': 23 ,'u': 22 ,'y': 21 ,'t': 20 ,'r': 19 ,'e': 18 ,'w': 17 ,'q': 16 ,'tab': 15 ,'a': 30 ,
    's': 31 ,'d': 32 ,'f': 33 ,'g': 34 ,'h': 35 ,'j': 36 ,'k': 37 ,'l': 38 ,';': 39 ,'\'': 40 ,'enter': 28 ,'right shift': 54 ,'/': 53 ,
    '.': 52 ,',': 51 ,'m': 50 ,'n': 49 ,'b': 48 ,'v': 47 ,'c': 46 ,'x': 45 ,'z': 44 ,'shift': 42 ,'ctrl': 29 ,'left windows': 91 ,'alt': 56 ,
    'space': 57 ,'ralt': 56 ,'menu': 93 ,'rctrl': 29 ,'caps lock': 58 ,'`': 41 ,'~': 41 ,'Q': 16 ,'W': 17 ,'E': 18 ,'R': 19 ,
    'T': 20 ,'Y': 21 ,'U': 22 ,'I': 23 ,'O': 24 ,'P': 25 ,'A': 30 ,'S': 31 ,'D': 32 ,'F': 33 ,'G': 34 ,'H': 35 ,'J': 36 ,'K': 37 ,'L': 38 ,
    'Z': 44 ,'X': 45 ,'C': 46 ,'V': 47 ,'B': 48 ,'N': 49 ,'M': 50 ,'?': 53 ,'f1': 59 ,'f2': 60 ,'f3': 61 ,'f4': 62 ,'f5': 63 ,'f6': 64 ,
    'f7': 65 ,'f8': 66 ,'f9': 67 ,'f10': 68 ,'f11': 87 ,'f12': 88 ,'up': 72 ,'left': 75 ,'right': 77 ,'down': 80 ,'delete': 83 ,'end': 79 ,
    'page down': 81 ,'home': 71 ,'insert': 82 ,'page up': 73 ,'–π': 16 ,'—Ü': 17 ,'—É': 18 ,'–∫': 19 ,'–µ': 20 ,'–Ω': 21 ,'–≥': 22 ,'—à': 23 ,'—â': 24 ,
    '–∑': 25 ,'—Ö': 26 ,'—ä': 27 ,'—Ñ': 30 ,'—ã': 31 ,'–≤': 32 ,'–∞': 33 ,'–ø': 34 ,'—Ä': 35 ,'–æ': 36 ,'–ª': 37 ,'–¥': 38 ,'–∂': 39 ,'—ç': 40 ,'–Ø': 44 ,'—á': 45 ,
    '—è': 44 ,'—Å': 46 ,'–º': 47 ,'–∏': 48 ,'—Ç': 49 ,'—å': 50 ,'–±': 51 ,'—é': 52 ,'.': 53 ,',': 53 ,'–ô': 16 ,'–¶': 17 ,'–£': 18 ,'–ö': 19 ,'–ï': 20 ,'–ù': 21 ,
    '–ì': 22 ,'–®': 23 ,'–©': 24 ,'–ó': 25 ,'–•': 26 ,'–™': 27 ,'–§': 30 ,'–´': 31 ,'–í': 32 ,'–ê': 33 ,'–ü': 34 ,'–†': 35 ,'–û': 36 ,'–õ': 37 ,'–î': 38 ,'–ñ': 39 ,
    '–≠': 40 ,'–ß': 45 ,'–°': 46 ,'–ú': 47 ,'–ò': 48 ,'–¢': 49 ,'–¨': 50 ,'–ë': 51 ,'–Æ': 52,'\\': 43,'Num0': 82 ,'Num1': 79 ,'Num2': 80 ,'Num3': 81 ,'Num4': 75 ,'Num5': 76 ,'Num6': 77 ,'Num7': 71 ,'Num8': 72 ,'Num9': 73 ,}
    
    key_status = {}
    toggle_status = {}
    key_replacements = {}
    
    def toggle(event):
        nonlocal activation_toggle, key_states
        activation_toggle = not activation_toggle
        if sound_enable.value:
            if activation_toggle:
                ws.Beep(int(500), int(200))
                ws.Beep(int(500), int(200))
            else:
                ws.Beep(int(100), int(400))
                for key in key_states:
                    keyboard.release(key)
                key_states = {}

    cruis_status = False
    def on_press(event):
        global toggle_key
        nonlocal cruis_status
        if event.scan_code == toggle_key and event.event_type == "down":
            if event.scan_code not in toggle_status or toggle_status[event.scan_code] == False:
                toggle_status[event.scan_code] = True
                toggle(event)
        elif event.scan_code == toggle_key and event.event_type == "up":
            if event.scan_code in toggle_status and toggle_status[event.scan_code] == True:
                toggle_status[event.scan_code] = False
        elif event.scan_code == toggle_keycruis and event.event_type == "up":
            if hotkeytogslider.value and activation_toggle:
                if cruis_status:
                    cruis_status = False
                else:
                    keyboard.press(toggle_keycruis)
                    cruis_status = True

        if activation_toggle and sendersl.value and event.name.upper() != toggle_key:
            if event.scan_code in keys_scan_codes:
                if event.event_type == "down":
                    if event.scan_code not in key_status or key_status[event.scan_code] == False:
                        key_status[event.scan_code] = True
                        try:
                            client.send(f"Sendkey|{event.scan_code}|True\n".encode('utf-8'))
                        except OSError as e:
                            if e.winerror == 10038 or e.winerror == 10054:
                                client_connect()
                elif event.event_type == "up":
                    if event.scan_code in key_status and key_status[event.scan_code] == True:
                        key_status[event.scan_code] = False
                        client.send(f"Sendkey|{event.scan_code}|False\n".encode('utf-8')) 
                    
  
    def update_keys():
        global keys , keys_scan_codes , key_replacements
        keys = [k.strip() for k in keys_input.value.split(",") if k.strip()]
        keys_scan_codes = [key_to_scan_code.get(key, None) for key in keys]
        keys_scan_codes = [code for code in keys_scan_codes if code is not None]
        #########################################################################
        key_replacements = parse_key_remap(replace_key_input.value)
        key_replacements = replace_keys_and_values(key_replacements, key_to_scan_code)
        #########################################################################

    def parse_key_remap(mapping_str):
        try:
            key_map = {}
            mappings = mapping_str.split(';')
            for mapping in mappings:
                key, value = mapping.split('=')
                key_map[str(key)] = list(map(str, value.split(',')))
            return key_map
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –∫–ª—é—á–µ–π –ø–æ–¥–º–µ–Ω—ã: {e}")
            return {}
    
    def replace_keys_and_values(data, key_to_scan_code):
        try:
            new_data = {}# –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            for key, values in data.items():# –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–ª—é—á–∞–º –∏ –∑–Ω–∞—á–µ–Ω–∏—è–º –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è
                new_key = key_to_scan_code.get(key, key)# –ó–∞–º–µ–Ω—è–µ–º –∫–ª—é—á, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ —Å–ª–æ–≤–∞—Ä–µ –∑–∞–º–µ–Ω—ã
                new_values = [key_to_scan_code.get(value, value) for value in values] # –ó–∞–º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ
                new_data[new_key] = new_values# –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–æ–≤—ã–π —Å–ª–æ–≤–∞—Ä—å
            return new_data
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–º–µ–Ω–µ –∫–ª—é—á–µ–π –∏ –∑–Ω–∞—á–µ–Ω–∏–π: {e}")
            return {}
        
        
    def start_monitoring():
        update_keys()
        page.update()
        
        keyboard.hook(on_press)
          
        
    def reciever():
        global client, key_replacements
        while True:
            data = client.recv(1024).decode('utf-8').split('\n')
            if not data:
                break
            for line in data:
                if line.startswith("Sendkey"):  # –ù–∞–∂–∞—Ç–∏–µ –∫–ª–∞–≤–∏—à–∏
                    input_key, state = line.split('|')[1], line.split('|')[2]
                    input_key = int(input_key)  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ
                    key_press_release(input_key,state)
                elif line.startswith("Get_citate"):
                    citate.value = client.recv(1024).decode('utf-8')
    
    
    
    key_states = {}              
    def key_press_release(input_key, state):
        global key_replacements
        nonlocal key_states
        
        if receiversl.value and activation_toggle:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∞–≤–∏—à, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
            keys_to_process = key_replacements.get(input_key, [input_key])
            
            for key in keys_to_process:
                if state == "True":
                    key_states[key] = key_states.get(key, 0) + 1
                else:
                    key_states[key] = max(key_states.get(key, 0) - 1, 0)
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –∫–ª–∞–≤–∏—à—É –≤ —Å–ø–∏—Å–∫–µ
            for key in keys_to_process:
                if key_states.get(key, 0) > 0:
                    keyboard.press(key)
                else:
                    keyboard.release(key)
                    


    def Auth():
        device_id = str(uuid.getnode())
        secret_key = "hrToJ2t73Q8c"
        auth_key = hashlib.sha256((device_id + secret_key).encode()).hexdigest()
        #print(auth_key)
        return auth_key
    
    global client_connect
    def client_connect():
        global client
        
        ip = "5.42.211.89" if str(ip_input.value) == "2MRDR" else str(ip_input.value)
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if 'client' in globals() and client:
            client.close()
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        try:
            client.connect((str(ip), int(port_input.value)))
            client.send(f"Auth|{Auth()}".encode('utf-8'))
            
            if client.recv(1024).decode('utf-8') == "access_success":
                client.sendall(f"Join_room|{str(private_key_input.value)}".encode('utf-8'))
                data1 = client.recv(1024).decode('utf-8').split('|')
                if data1[0] == "Join_room":
                    pass
                client.sendall(f"Get_citate|1".encode('utf-8'))
                citate.value = client.recv(4096).decode('utf-8')
                page.update()
            else:
                whitelist_id.value = Auth()
                page.open(whitelistdlg)
                #print("access_denied")
                
            threading.Thread(target=reciever,daemon=True).start()
        except Exception as e:
            #print(f"Connection error: {e}")
            if client:
                client.close()
                
    sl_sound_toggle()
    client_connect()
    start_monitoring()
    ##################################################################################################################################################


ft.app(target=main)

